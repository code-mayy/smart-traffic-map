<!DOCTYPE html>
<html>
<head>
  <title>Smart Traffic & Ambulance System</title>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    #dashboard {
      position: absolute; top:10px; left:10px; z-index:1000;
      background:white; padding:15px; width:300px;
      border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.2);
    }
    #dashboard input, button, select {
      width:100%; box-sizing: border-box; margin-bottom:8px; padding:6px;
      border-radius:5px; border:1px solid #ccc;
    }
    button {
      background:#28a745; color:white; border:none;
      font-weight:bold; cursor:pointer;
    }
    .red-btn {
      background:#dc3545; color:white;
    }
    #alert-box {
        display: none; position: absolute; top: 10px; right: 10px; z-index: 1000;
        background: #ffc107; color: black; padding: 15px; border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3); font-weight: bold;
    }
  </style>
</head>
<body>
<div id="dashboard">
  <h3>ğŸš¦ Smart Traffic & Ambulance</h3>
  <input id="searchInput" placeholder="Search any location..." />
  <button onclick="searchPlace()">Search & Show Routes</button>
  <hr>
  <h4>ğŸš¨ Report Issue</h4>
  <select id="reportType">
    <option value="Accident">Accident</option>
    <option value="Pothole">Pothole</option>
    <option value="Road Block">Road Block</option>
  </select>
  <p>ğŸ“ Click on map to mark issue</p>
  <button onclick="submitReport()">Submit Report</button>
  <hr>
  <button class="red-btn" onclick="dispatchAmbulance()">ğŸš‘ Dispatch Ambulance</button>
  <hr>
  <h4>ğŸ“ Emergency Call</h4>
  <button class="red-btn" onclick="callPolice()">ğŸš“ Call Police</button>
  <button class="red-btn" onclick="callFireForce()">ğŸš’ Call Fire Force</button>
</div>

<div id="alert-box"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([11.0030, 76.0015], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: 'Â© OpenStreetMap contributors' }).addTo(map);

const currentLocation = [11.0030, 76.0015];
L.marker(currentLocation).addTo(map).bindPopup("ğŸ“ Current Location");

const hospitals = [
  { name:"Almas Hospital", lat:10.99988, lng:75.99082 },
  { name:"Aster MIMS Hospital", lat: 10.99601, lng:75.99420 },
  { name:"Neha Hospital", lat:10.99973, lng:75.99607 },
  { name:"Community Health (MIMS)", lat:11.0545, lng:76.0018 },
  { name:"Taluk Hospital Kottakkal", lat: 11.00085, lng: 76.00812 }
];
hospitals.forEach(h=> L.marker([h.lat,h.lng]).addTo(map).bindPopup("ğŸ¥ "+h.name));

let clickedLatLng=null;
let reportMarkers=[], routeLayers=[];
let vehiclePathLayer = null; // To hold the incoming vehicle path

map.on('click', e => {
  clickedLatLng = e.latlng;
  L.popup().setLatLng(clickedLatLng).setContent("ğŸ“ Selected: "+clickedLatLng.lat.toFixed(4)+", "+clickedLatLng.lng.toFixed(4)).openOn(map);
});

function clearRoutes(){
  routeLayers.forEach(r=>map.removeLayer(r));
  routeLayers=[];
}

async function searchPlace(){
  const q = document.getElementById('searchInput').value;
  if(!q) return alert("Enter location");
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
  const d = await r.json();
  if (!d[0]) return alert("Not found");
  const lat=parseFloat(d[0].lat), lng=parseFloat(d[0].lon);
  const dest=[lat,lng];
  L.marker(dest).addTo(map).bindPopup("ğŸ“ "+d[0].display_name).openPopup();
  map.setView(dest,14);
  drawMultipleRoutes([userLocation.lat, userLocation.lng], dest);
}

function generateWaypoints(start,end){
  const midLat=(start[0]+end[0])/2, midLng=(start[1]+end[1])/2;
  return [
    [midLat+0.003, midLng],
    [midLat-0.002, midLng+0.008],
    [midLat-0.002, midLng-0.008]
  ];
}

async function drawMultipleRoutes(start,end){
  clearRoutes();
  const wps = generateWaypoints(start,end);
  const cols = ['green','orange','red'];
  for(let i=0;i<3;i++){
    const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${wps[i][1]},${wps[i][0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
    try{
      const res = await fetch(url), json = await res.json();
      if(json.routes?.[0]){
        const coords=json.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
        const pl=L.polyline(coords,{color:cols[i],weight:6,opacity:0.9})
          .addTo(map)
          .bindPopup(`ğŸ›£ï¸ ${cols[i].toUpperCase()} route<br>Dist: ${(json.routes[0].distance/1000).toFixed(2)}km<br>Time: ${(json.routes[0].duration/60).toFixed(1)}min`);
        routeLayers.push(pl);
      }
    }catch(e){ console.error(e); }
  }
}

function submitReport(){
  if(!clickedLatLng) return alert("Click map first");
  const type=document.getElementById('reportType').value;
  const icon = type==='Accident' ? 'ğŸš§' : (type==='Pothole' ? 'ğŸ•³ï¸' : 'â›”');
  const popup=`${icon} ${type}<br><button onclick="deleteMarker(this)">ğŸ—‘ï¸ Delete</button>`;
  const m=L.marker(clickedLatLng).addTo(map).bindPopup(popup).openPopup();
  reportMarkers.push({marker:m,type:type, latlng: clickedLatLng});
}

function deleteMarker(btn){
  reportMarkers.forEach((obj,i)=>{
    if(obj.marker.getPopup().getContent().includes(btn.outerHTML)){
      map.removeLayer(obj.marker);
      reportMarkers.splice(i,1);
    }
  });
}

// ** MODIFIED to send alert to Emergency Map **
function dispatchAmbulance(){
  const lastReport = reportMarkers.slice().reverse().find(r => r.type === "Accident");
  if (!lastReport) {
    return alert("âŒ Please report an accident before dispatching.");
  }
  const lastAccident = lastReport.latlng;
  
  // Create data packet for the emergency map
  const alertData = {
      lat: lastAccident.lat,
      lng: lastAccident.lng
  };
  
  // Send the alert via localStorage
  localStorage.setItem('emergencyAlert', JSON.stringify(alertData));
  alert(`âœ… Ambulance Dispatched! Location sent to emergency services.`);
}

// ** NEW: Listens for incoming routes from the Emergency Map **
function listenForVehicleRoute() {
    const alertBox = document.getElementById('alert-box');
    const vehicleDataJSON = localStorage.getItem('activeVehicleAlert');

    // Always clear the previous path layer
    if (vehiclePathLayer) {
        map.removeLayer(vehiclePathLayer);
        vehiclePathLayer = null;
    }

    if (vehicleDataJSON) {
        const data = JSON.parse(vehicleDataJSON);
        if (data.path && data.path.length > 0) {
            
            // Draw the vehicle path on the map
            vehiclePathLayer = L.polyline(data.path, {
                color: 'blue',
                weight: 5,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);

            const vehicleStartLocation = L.latLng(data.path[0][0], data.path[0][1]);
            const distanceToVehicle = userLocation.distanceTo(vehicleStartLocation);

            // Show alert if user is within 500 meters of the vehicle's starting point
            if (distanceToVehicle < 500) {
                const serviceIcon = data.service === 'ambulance' ? 'ğŸš‘' : 'ğŸš’';
                alertBox.innerHTML = `âš ï¸ ${serviceIcon} ${data.service.toUpperCase()} approaching! Their route is shown in blue.`;
                alertBox.style.display = 'block';
            } else {
                alertBox.style.display = 'none';
            }
        }
    } else {
        // If no active alert, ensure the box is hidden
        alertBox.style.display = 'none';
    }
}


// Emergency Calls
function callPolice() {
  alert("ğŸ“ Calling Police Helpline: 100");
}
function callFireForce() {
  alert("ğŸ“ Calling Fire Force: 101");
}

// Start listening for vehicle routes every 3 seconds
setInterval(listenForVehicleRoute, 3000);

</script>
</body>
</html>